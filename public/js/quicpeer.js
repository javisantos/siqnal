var e=1e3,t=60*e,s=60*t,n=24*s,i=7*n,r=365.25*n,a=function(a,c){c=c||{};var h=typeof a;if("string"===h&&a.length>0)return function(a){if((a=String(a)).length>100)return;var o=/^((?:\d+)?\-?\d?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(!o)return;var c=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*r;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*n;case"hours":case"hour":case"hrs":case"hr":case"h":return c*s;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===h&&!1===isNaN(a))return c.long?function(i){var r=Math.abs(i);if(r>=n)return o(i,r,n,"day");if(r>=s)return o(i,r,s,"hour");if(r>=t)return o(i,r,t,"minute");if(r>=e)return o(i,r,e,"second");return i+" ms"}(a):function(i){var r=Math.abs(i);if(r>=n)return Math.round(i/n)+"d";if(r>=s)return Math.round(i/s)+"h";if(r>=t)return Math.round(i/t)+"m";if(r>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function o(e,t,s,n){var i=t>=1.5*s;return Math.round(e/s)+" "+n+(i?"s":"")}var c,h=function(e){function t(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return s.colors[Math.abs(t)%s.colors.length]}function s(e){let r;function a(...e){if(!a.enabled)return;const t=a,n=Number(new Date),i=n-(r||n);t.diff=i,t.prev=r,t.curr=n,r=n,e[0]=s.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,i)=>{if("%%"===n)return n;o++;const r=s.formatters[i];if("function"==typeof r){const s=e[o];n=r.call(t,s),e.splice(o,1),o--}return n}),s.formatArgs.call(t,e),(t.log||s.log).apply(t,e)}return a.namespace=e,a.enabled=s.enabled(e),a.useColors=s.useColors(),a.color=t(e),a.destroy=n,a.extend=i,"function"==typeof s.init&&s.init(a),s.instances.push(a),a}function n(){const e=s.instances.indexOf(this);return-1!==e&&(s.instances.splice(e,1),!0)}function i(e,t){const n=s(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return s.debug=s,s.default=s,s.coerce=function(e){return e instanceof Error?e.stack||e.message:e},s.disable=function(){const e=[...s.names.map(r),...s.skips.map(r).map(e=>"-"+e)].join(",");return s.enable(""),e},s.enable=function(e){let t;s.save(e),s.names=[],s.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),i=n.length;for(t=0;t<i;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?s.skips.push(new RegExp("^"+e.substr(1)+"$")):s.names.push(new RegExp("^"+e+"$")));for(t=0;t<s.instances.length;t++){const e=s.instances[t];e.enabled=s.enabled(e.namespace)}},s.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=s.skips.length;t<n;t++)if(s.skips[t].test(e))return!1;for(t=0,n=s.names.length;t<n;t++)if(s.names[t].test(e))return!0;return!1},s.humanize=a,Object.keys(e).forEach(t=>{s[t]=e[t]}),s.instances=[],s.names=[],s.skips=[],s.formatters={},s.selectColor=t,s.enable(s.load()),s},u=(function(e,t){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;t.splice(1,0,s,"color: inherit");let n=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(i=n))}),t.splice(i,0,s)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=h(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(c={exports:{}},c.exports),c.exports);u.log,u.formatArgs,u.save,u.load,u.useColors,u.storage,u.colors;class QuicPeer{constructor(e,t){this.ice=new RTCIceTransport,this.quic=new RTCQuicTransport(this.ice);let s=Math.random().toString(36).substring(2,8)+Math.random().toString(36).substring(2,8);return this.key="string"==typeof e?e:s,this.options="object"==typeof t?t:e,this.initiator="object"==typeof this.options&&(!!this.options.initiator&&this.options.initiator),this.gatherOptions="object"==typeof this.options&&this.options.gatherOptions?this.options.gatherOptions:{},this.sendStream=null,this.receiveStream=null,this.started=!1,this.handlers=new Map,this._usernameFragment=null,this.options&&this.options.debug?localStorage.debug="*":localStorage.debug=!1,this.log=u(`peer:${this.key?this.key:s}`),this._listeners(),this.emit("ready"),this}_listeners(){this.ice.onstatechange=()=>{this.log("ICE transport %o",this.ice.state),"connected"===this.ice.state&&this.initiator&&this.quic.connect(),this.emit("statechange",this.ice.state)},this.ice.onicecandidate=e=>{e.candidate&&this.log("ICE candidate %O",e.candidate),this.emit("icecandidate",e.candidate)},this.ice.onselectedcandidatepairchange=()=>{var e=this.ice.getSelectedCandidatePair();this.log("Selected candidate pair is %o",e),this.emit("selectedcandidatepairchange",e)},this.ice.ongatheringstatechange=()=>{if(this.log("Gathering state is %o",this.ice.gatheringState,this.ice.getLocalCandidates()),"complete"===this.ice.gatheringState){let e={iceParams:this.ice.getLocalParameters(),candidates:this.ice.getLocalCandidates()};if(this.initiator)e.quicKey=this.quicKey;else{this.ice.start(this.remoteIceParams.iceParams);let e=this.str2ab(this.remoteIceParams.quicKey);this.quic.listen(e)}this._usernameFragment=e.iceParams.usernameFragment,this.log("Signaling %o %O",this._usernameFragment,e),this.emit("signal",e)}},this.quic.onstatechange=()=>{this.log("QUIC transport %o",this.quic.state),"connected"!==this.quic.state||this.sendStream||(this.sendStream=this.quic.createStream("mychannel"),this.emit("connect"))},this.quic.addEventListener("quicstream",e=>{this.log("QUIC transport got a stream %O",e.stream),this.receiveStream=e.stream,console.log("stream...",this.receiveStream),this.receiveStream.onstatechange=e=>{console.log("stream change state",e,this.receiveStream.state)},this.receiveStream.waitForReadable(1).then(()=>this.ondata()).catch(e=>{console.log("stream closed?",e)})})}get quicKey(){return String.fromCharCode.apply(null,new Uint16Array(this.quic.getKey()))}get usernameFragment(){return this._usernameFragment}write(e){const t=(new TextEncoder).encode(e);this.log("Writing",e),this.sendStream.write({data:t})}async ondata(){if("open"===this.receiveStream.state){const e=new Uint8Array(this.receiveStream.readBufferedAmount);this.receiveStream.readInto(e);const t=(new TextDecoder).decode(e);this.log("Receiving",t),this.emit("data",t);try{await this.receiveStream.waitForReadable(1)}catch(e){console.log("stream closed")}this.ondata()}}signal(e){e.candidates&&e.candidates.forEach(e=>{this.log("Adding remote candidate %O",e),this.ice.addRemoteCandidate(new RTCIceCandidate(e))}),this.initiator?(this.log("Connecting to %o %O",e.iceParams.usernameFragment,e.iceParams),this.ice.start(e.iceParams)):(this.log("Listening to %o %O",e.iceParams.usernameFragment,e),this.remoteIceParams=e,this.ice.gather({...this.gatherOptions}))}str2ab(e){for(var t=new ArrayBuffer(2*e.length),s=new Uint16Array(t),n=0,i=e.length;n<i;n++)s[n]=e.charCodeAt(n);return t}buf2hex(e){return Array.prototype.map.call(new Uint8Array(e),e=>("00"+e.toString(16)).slice(-2)).join("")}get quicKey(){return String.fromCharCode.apply(null,new Uint16Array(this.quic.getKey()))}on(e,t){if("string"==typeof e&&"function"==typeof t){if("signal"===e&&"function"==typeof t&&this.initiator){let e={iceParams:this.ice.getLocalParameters(),quicKey:this.quicKey};console.log("init with",this.ice.getLocalParameters()),this.ice.gather({...this.gatherOptions}),this.started=!0,this.log("Initiator init %o %O",e.iceParams.usernameFragment,e),this._usernameFragment=e.iceParams.usernameFragment}this.handlers.set(e,t)}}off(e){this.handlers.delete(e)}emit(e,t){"string"==typeof e&&(this.handlers.has(e)&&this.handlers.get(e)(t),this.handlers.has("*")&&this.handlers.get("*")(e,t))}}export default QuicPeer;export{QuicPeer};
